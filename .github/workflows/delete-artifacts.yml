name: Delete All Artifacts

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "DELETE" to confirm deletion of all artifacts'
        required: true
        type: string

# Required permissions to read and delete artifacts
permissions:
  actions: write

jobs:
  delete-artifacts:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.confirm == 'DELETE' }}
    steps:
      - name: Delete all artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            
            console.log(`Fetching artifacts for ${owner}/${repo}...`);
            
            // Get all artifacts
            const artifacts = await github.paginate(
              github.rest.actions.listArtifactsForRepo,
              { owner, repo, per_page: 100 }
            );
            
            console.log(`Found ${artifacts.length} artifacts to delete.`);
            
            if (artifacts.length === 0) {
              console.log('No artifacts found. Nothing to delete.');
              return;
            }
            
            // Delete each artifact
            let deleted = 0;
            let failed = 0;
            
            for (const artifact of artifacts) {
              try {
                await github.rest.actions.deleteArtifact({
                  owner,
                  repo,
                  artifact_id: artifact.id
                });
                console.log(`✓ Deleted: ${artifact.name} (ID: ${artifact.id}, Size: ${(artifact.size_in_bytes / 1024 / 1024).toFixed(2)} MB)`);
                deleted++;
              } catch (error) {
                console.log(`✗ Failed to delete: ${artifact.name} - ${error.message}`);
                failed++;
              }
            }
            
            console.log(`\n=== Summary ===`);
            console.log(`Total artifacts: ${artifacts.length}`);
            console.log(`Successfully deleted: ${deleted}`);
            console.log(`Failed: ${failed}`);

  confirm-required:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.confirm != 'DELETE' }}
    steps:
      - name: Confirmation required
        run: |
          echo "❌ Deletion cancelled!"
          echo "You must type 'DELETE' (exactly) to confirm artifact deletion."
          echo "You entered: '${{ github.event.inputs.confirm }}'"
          exit 1

